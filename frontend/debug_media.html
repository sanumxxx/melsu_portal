<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ - MelSU Portal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .loading { background-color: #cce7ff; color: #004085; }
        .media-test {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        .media-container {
            max-width: 300px;
            margin: 10px 0;
        }
        img, video {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤</h1>
        
        <div class="test-result loading">
            <strong>–°—Ç–∞—Ç—É—Å:</strong> –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
        </div>

        <div>
            <h3>–¢–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã:</h3>
            <button onclick="testUploadsAPI()">üìä –¢–µ—Å—Ç API uploads</button>
            <button onclick="testCurrentAnnouncement()">üì¢ –¢–µ—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</button>
            <button onclick="testStaticFiles()">üìÅ –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤</button>
            <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const results = document.getElementById('results');

        function addResult(type, message) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function clearResults() {
            results.innerHTML = '';
        }

        async function testUploadsAPI() {
            addResult('loading', '<span class="spinner"></span> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API uploads...');
            
            try {
                const response = await fetch('/debug/uploads');
                if (response.ok) {
                    const data = await response.json();
                    addResult('success', `‚úÖ API uploads —Ä–∞–±–æ—Ç–∞–µ—Ç. –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${data.announcements_files_count}`);
                    
                    if (data.recent_announcements_files?.length > 0) {
                        addResult('success', `üìÅ –ù–µ–¥–∞–≤–Ω–∏–µ —Ñ–∞–π–ª—ã: ${data.recent_announcements_files.slice(0, 3).join(', ')}`);
                    }
                } else {
                    addResult('error', `‚ùå API uploads –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                addResult('error', `‚ùå –û—à–∏–±–∫–∞ API uploads: ${error.message}`);
            }
        }

        async function testCurrentAnnouncement() {
            addResult('loading', '<span class="spinner"></span> –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è...');
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    addResult('error', '‚ùå –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
                    return;
                }

                const response = await fetch('/api/announcements/current', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.has_unviewed && data.announcement) {
                        const announcement = data.announcement;
                        addResult('success', `‚úÖ –ù–∞–π–¥–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: "${announcement.title}"`);
                        
                        if (announcement.has_media && announcement.media_url) {
                            await testMediaFile(announcement.media_url, announcement.media_type, '–ú–µ–¥–∏–∞—Ñ–∞–π–ª –æ–±—ä—è–≤–ª–µ–Ω–∏—è');
                        } else if (announcement.image_url) {
                            await testMediaFile(announcement.image_url, 'image', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è');
                        } else {
                            addResult('warning', '‚ö†Ô∏è –û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤');
                        }
                    } else {
                        addResult('warning', '‚ö†Ô∏è –ù–µ—Ç –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π');
                    }
                } else {
                    addResult('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                addResult('error', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è: ${error.message}`);
            }
        }

        async function testMediaFile(mediaUrl, mediaType, description) {
            const fullUrl = mediaUrl.startsWith('http') ? mediaUrl : window.location.origin + mediaUrl;
            
            addResult('loading', `<span class="spinner"></span> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${description}: ${mediaUrl}...`);
            
            try {
                // –¢–µ—Å—Ç HEAD –∑–∞–ø—Ä–æ—Å–∞
                const headResponse = await fetch(fullUrl, { method: 'HEAD' });
                if (headResponse.ok) {
                    const contentType = headResponse.headers.get('content-type');
                    const contentLength = headResponse.headers.get('content-length');
                    addResult('success', `‚úÖ ${description} –¥–æ—Å—Ç—É–ø–µ–Ω (${contentType}, ${contentLength ? Math.round(contentLength/1024) + 'KB' : '—Ä–∞–∑–º–µ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'})`);
                    
                    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
                    const mediaDiv = document.createElement('div');
                    mediaDiv.className = 'media-test';
                    mediaDiv.innerHTML = `<h4>${description}</h4><div class="media-container" id="media-${Date.now()}"></div>`;
                    results.appendChild(mediaDiv);
                    
                    const container = mediaDiv.querySelector('.media-container');
                    
                    if (mediaType === 'video' || mediaUrl.includes('.mp4') || mediaUrl.includes('.webm') || mediaUrl.includes('.mov')) {
                        const video = document.createElement('video');
                        video.src = fullUrl;
                        video.controls = true;
                        video.muted = true;
                        video.onloadeddata = () => addResult('success', `‚úÖ ${description} - –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ`);
                        video.onerror = () => addResult('error', `‚ùå ${description} - –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ`);
                        container.appendChild(video);
                    } else {
                        const img = document.createElement('img');
                        img.src = fullUrl;
                        img.onload = () => addResult('success', `‚úÖ ${description} - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ`);
                        img.onerror = () => addResult('error', `‚ùå ${description} - –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è`);
                        container.appendChild(img);
                    }
                } else {
                    addResult('error', `‚ùå ${description} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${headResponse.status} ${headResponse.statusText}`);
                }
            } catch (error) {
                addResult('error', `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ${description}: ${error.message}`);
            }
        }

        async function testStaticFiles() {
            addResult('loading', '<span class="spinner"></span> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤...');
            
            // –¢–µ—Å—Ç –æ–±—â–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–∞–ø–∫–∏ uploads
            try {
                const testUrls = [
                    '/uploads/',
                    '/uploads/announcements/',
                ];

                for (const url of testUrls) {
                    try {
                        const response = await fetch(url);
                        if (response.ok || response.status === 403) {  // 403 –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–æ listing –∑–∞–ø—Ä–µ—â–µ–Ω
                            addResult('success', `‚úÖ –ü–∞–ø–∫–∞ ${url} –¥–æ—Å—Ç—É–ø–Ω–∞ (${response.status})`);
                        } else {
                            addResult('error', `‚ùå –ü–∞–ø–∫–∞ ${url} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ${response.status}`);
                        }
                    } catch (error) {
                        addResult('error', `‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ ${url}: ${error.message}`);
                    }
                }
            } catch (error) {
                addResult('error', `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤: ${error.message}`);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –±–∞–∑–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            addResult('success', 'üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤.');
        });
    </script>
</body>
</html> 