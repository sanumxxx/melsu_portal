name: üöÄ Auto Deploy to Server (Simple Improved)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server with migrations
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          cd /var/www/melsu
          
          # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
          echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –ë–î..."
          mkdir -p /var/backups/melsu
          sudo -u postgres pg_dump melsu_db > /var/backups/melsu/backup_$(date +%Y%m%d_%H%M%S).sql
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞
          CURRENT_COMMIT=$(git rev-parse HEAD)
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
          git pull origin main
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö backend
          if git diff --name-only $CURRENT_COMMIT HEAD | grep -q "backend/requirements.txt"; then
            echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            cd backend && sudo -u melsu venv/bin/pip install -r requirements.txt && cd ..
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö frontend
          if git diff --name-only $CURRENT_COMMIT HEAD | grep -q "frontend/package.json"; then
            echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            cd frontend && sudo -u melsu npm install && cd ..
          fi
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
          echo "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
          cd backend
          sudo -u melsu venv/bin/alembic upgrade head || {
            echo "‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π! –û—Ç–∫–∞—Ç—ã–≤–∞—é –∫–æ–¥..."
            cd ..
            git reset --hard $CURRENT_COMMIT
            exit 1
          }
          cd ..
          
          # –°–æ–±–∏—Ä–∞–µ–º frontend –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --name-only $CURRENT_COMMIT HEAD | grep -q "frontend/"; then
            echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ frontend..."
            cd frontend && sudo -u melsu npm run build && cd ..
          fi
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          if command -v melsu &> /dev/null; then
            melsu restart
          else
            systemctl restart melsu-worker melsu-api
            systemctl reload nginx
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
          echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
          for i in {1..15}; do
            if curl -s http://localhost:8000/health > /dev/null; then
              echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç!"
              exit 1
            fi
            sleep 2
          done
          
          echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!" 