name: üöÄ Auto Deploy to Server (Improved)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

env:
  PROJECT_PATH: "/var/www/melsu"

jobs:
  deploy:
    if: github.event_name == 'push' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    name: üîÑ Deploy to Production Server
    
    steps:
    - name: üìù Checkout code
      uses: actions/checkout@v4
      
    - name: üöÄ Deploy to server with safety checks
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –ø–∞—Ä–æ–ª—å, —Ç–∞–∫ –∏ SSH –∫–ª—é—á
        password: ${{ secrets.SERVER_PASSWORD }}
        # key: ${{ secrets.SERVER_SSH_KEY }}  # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è SSH –∫–ª—é—á–∞
        script: |
          set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
          
          echo "üîÑ –ù–∞—á–∏–Ω–∞—é –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ MELSU Portal..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd ${{ env.PROJECT_PATH }}
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ melsu –¥–æ—Å—Ç—É–ø–Ω–∞
          if ! command -v melsu &> /dev/null; then
            echo "‚ö†Ô∏è  –ö–æ–º–∞–Ω–¥–∞ melsu –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã..."
            
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
            echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
            git pull origin main
            
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
            systemctl restart melsu-api melsu-worker nginx || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±..."
              systemctl stop melsu-api melsu-worker
              sleep 5
              systemctl start melsu-api melsu-worker
              systemctl reload nginx
            }
            
            echo "‚úÖ –ë–∞–∑–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
            exit 0
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã..."
          melsu status || echo "‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
          
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –∫–æ–º–º–∏—Ç–µ
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "üìå –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $CURRENT_COMMIT"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
          git fetch origin main
          REMOTE_COMMIT=$(git rev-parse origin/main)
          
          if [ "$CURRENT_COMMIT" = "$REMOTE_COMMIT" ]; then
            echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
            exit 0
          fi
          
          echo "üÜï –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –ø—Ä–∏–º–µ–Ω—è—é..."
          
          # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
          echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ë–î..."
          melsu backup || {
            echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø, —Å–æ–∑–¥–∞—é –≤—Ä—É—á–Ω—É—é..."
            mkdir -p /var/backups/melsu
            sudo -u postgres pg_dump melsu_db > /var/backups/melsu/backup_$(date +%Y%m%d_%H%M%S).sql
          }
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          echo "‚¨áÔ∏è  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
          git pull origin main
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
          if git diff --name-only $CURRENT_COMMIT HEAD | grep -q "backend/requirements.txt"; then
            echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            cd backend
            sudo -u melsu venv/bin/pip install -r requirements.txt
            cd ..
          fi
          
          if git diff --name-only $CURRENT_COMMIT HEAD | grep -q "frontend/package.json"; then
            echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            cd frontend
            sudo -u melsu npm install
            cd ..
          fi
          
          # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
          echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π..."
          melsu diagnose-migrations || {
            echo "‚ö†Ô∏è  –ö–æ–º–∞–Ω–¥–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è—é –≤—Ä—É—á–Ω—É—é..."
            cd backend
            echo "–¢–µ–∫—É—â–∏–µ head —Ä–µ–≤–∏–∑–∏–∏:"
            sudo -u melsu venv/bin/alembic heads || true
            cd ..
          }
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
          echo "üóÑÔ∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î..."
          melsu fix-migrations || {
            echo "‚ö†Ô∏è  –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –∏—Å–ø—Ä–∞–≤–ª—è—é –≤—Ä—É—á–Ω—É—é..."
            cd backend
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ head —Ä–µ–≤–∏–∑–∏–π
            HEADS_COUNT=$(sudo -u melsu venv/bin/alembic heads 2>/dev/null | wc -l)
            
            if [ "$HEADS_COUNT" -gt 1 ]; then
              echo "üîß –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ $HEADS_COUNT head —Ä–µ–≤–∏–∑–∏–π, —Å–æ–∑–¥–∞—é merge..."
              
              # –°–æ–∑–¥–∞–µ–º merge —Ä–µ–≤–∏–∑–∏—é –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è heads
              sudo -u melsu venv/bin/alembic merge heads -m "Auto-merge multiple heads during deployment" || {
                echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å merge —Ä–µ–≤–∏–∑–∏—é!"
                echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö:"
                sudo -u melsu venv/bin/alembic heads
                sudo -u melsu venv/bin/alembic current
                echo "üîÑ –û—Ç–∫–∞—Ç—ã–≤–∞—é –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É..."
                git reset --hard $CURRENT_COMMIT
                exit 1
              }
            fi
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            sudo -u melsu venv/bin/alembic upgrade head || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π!"
              echo "üìã –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
              sudo -u melsu venv/bin/alembic current
              sudo -u melsu venv/bin/alembic heads
              sudo -u melsu venv/bin/alembic history -v | tail -10
              echo "üîÑ –û—Ç–∫–∞—Ç—ã–≤–∞—é –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É..."
              git reset --hard $CURRENT_COMMIT
              exit 1
            }
            cd ..
          }
          
          # –°–æ–±–∏—Ä–∞–µ–º frontend –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --name-only $CURRENT_COMMIT HEAD | grep -q "frontend/"; then
            echo "üèóÔ∏è  –°–±–æ—Ä–∫–∞ frontend..."
            cd frontend
            sudo -u melsu npm install
            cd ..
          fi
          
          # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
          echo "üîÑ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          if command -v melsu &> /dev/null; then
            melsu restart
          else
            # Graceful restart
            systemctl restart melsu-worker
            sleep 2
            systemctl restart melsu-api
            sleep 3
            systemctl reload nginx
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
          echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã..."
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ API
          for i in {1..30}; do
            if curl -s http://localhost:8000/health > /dev/null 2>&1; then
              echo "‚úÖ API –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 60 —Å–µ–∫—É–Ω–¥!"
              echo "üìã –õ–æ–≥–∏ API:"
              journalctl -u melsu-api -n 10 --no-pager
              exit 1
            fi
            sleep 2
          done
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend
          if curl -s -I http://localhost/ | head -1 | grep -q "200 OK"; then
            echo "‚úÖ Frontend –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚ö†Ô∏è  Frontend –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ë–î
          if sudo -u postgres psql melsu_db -c "SELECT 1;" > /dev/null 2>&1; then
            echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞"
          else
            echo "‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö!"
            exit 1
          fi
          
          # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
          echo "üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:"
          if command -v melsu &> /dev/null; then
            melsu status
          else
            systemctl --no-pager status melsu-api melsu-worker nginx
          fi
          
          echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
          echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://$(curl -s ifconfig.me 2>/dev/null || echo 'your-server-ip')"
          
    - name: üîî Notify on failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        # key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "‚ùå –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π!"
          echo "üìã –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
          systemctl --no-pager status melsu-api melsu-worker nginx || true
          echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ API:"
          journalctl -u melsu-api -n 20 --no-pager || true
          echo "üìã –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π:"
          cd ${{ env.PROJECT_PATH }}/backend
          sudo -u melsu venv/bin/alembic current || true
          sudo -u melsu venv/bin/alembic heads || true
