# Миграция на новую систему назначений

## Обзор изменений

Проведена полная миграция с **старой системы одиночных назначений** на **новую систему множественных назначений**. Старая система полностью удалена из кодовой базы.

## Что было удалено (Старая система)

### Backend
1. **Поля в базе данных:**
   - `user_profiles.department_id` - ID подразделения
   - `user_profiles.department_role_id` - ID роли в подразделении

2. **API эндпоинты:**
   - `POST /users/assign-department` - назначение пользователя в подразделение

3. **Модели и схемы:**
   - Поля `department_id` и `department_role_id` из `UserProfile`
   - Связи `department_rel` и `department_role_rel` из `UserProfile`
   - Схема `UserDepartmentAssignment` в `users.py`

4. **Логика в API:**
   - Все ссылки на `department_role_id` и `department_id` в профилях
   - Логика возврата `department_role` и `assigned_department`

### Frontend
1. **Компоненты:**
   - Старые поля отображения `department_role` в модальных окнах
   - Логика назначения через `/users/assign-department`
   - Старые секции с единичными назначениями

2. **API вызовы:**
   - `api.post('/users/assign-department')` заменен на новую систему assignments

### Тестовые файлы
Удалены старые тестовые файлы:
- `backend/check_user_data.py`
- `backend/check_data.py` 
- `backend/test_api_response.py`

## Что осталось (Новая система)

### Backend
1. **Новая таблица:** `user_department_assignments`
   - Множественные назначения пользователей
   - Поддержка временных назначений
   - Указание нагрузки в процентах
   - Основные/дополнительные назначения

2. **Новые API эндпоинты:** `/api/assignments/*`
   - `GET/POST /users/{user_id}` - управление назначениями пользователя
   - `PUT/DELETE /{assignment_id}` - редактирование/удаление назначений
   - `PUT /{assignment_id}/primary` - установка основного назначения
   - `POST /bulk` - массовые назначения
   - `GET /stats` - статистика назначений

3. **Модели:**
   - `UserDepartmentAssignment` - полная модель назначений
   - Обновленные связи в `User` и `Department`

### Frontend  
1. **Новые компоненты:**
   - `AssignmentManager` - управление назначениями
   - `AssignmentsDisplay` - отображение назначений в профиле и модальном окне

2. **Обновленные компоненты:**
   - `Profile.jsx` - новое отображение назначений
   - `Users.jsx` - интеграция с менеджером назначений

## Преимущества новой системы

1. **Множественные назначения** - пользователь может работать в нескольких подразделениях
2. **Разные роли** - разные должности в разных подразделениях  
3. **Временные назначения** - с датами начала и окончания
4. **Нагрузка** - указание процента занятости (1-100%)
5. **Типы назначений** - постоянное, временное, исполняющий обязанности
6. **Основное назначение** - выделение основного места работы
7. **Ограничение ролей** - можно назначать только роли, которые есть у пользователя

## Миграция данных

Все существующие назначения из старой системы автоматически перенесены в новую:
- `department_id` + `department_role_id` → новое назначение в `user_department_assignments`
- Все старые назначения отмечены как основные (`is_primary = true`)
- Тип назначения установлен как "permanent"
- Нагрузка установлена как 100%

## Обратная совместимость

⚠️ **Обратная совместимость НЕ поддерживается**

Старые API эндпоинты удалены. Клиенты должны использовать новые endpoints:
- Вместо `POST /users/assign-department` → `POST /api/assignments/users/{user_id}`
- Вместо полей `department_role` → данные из `/api/assignments/users/{user_id}`

## Применение изменений

1. ✅ Применена миграция базы данных: `023_remove_old_assignment_system`
2. ✅ Обновлен backend код
3. ✅ Обновлен frontend код  
4. ✅ Удалены тестовые файлы старой системы

## Проверка работоспособности

После миграции проверьте:
1. Отображение назначений в профиле пользователя
2. Работу менеджера назначений в административной панели
3. Создание/редактирование/удаление назначений
4. Установку основного назначения
5. Фильтрацию доступных ролей по ролям пользователя

---

**Дата миграции:** 25 января 2025  
**Статус:** ✅ Завершено  
**Результат:** Полный переход на новую систему множественных назначений 